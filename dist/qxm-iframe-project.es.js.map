{"version":3,"file":"qxm-iframe-project.es.js","sources":["../src/constants/errors.ts","../src/utils/checkOrigin.ts","../src/constants/allowedDomains.ts","../src/utils/checkDomain.ts","../src/utils/decodeToken.ts","../src/index.ts"],"sourcesContent":["import { Errors } from '../interfaces/index';\n\nconst errors: Errors = {\n    SDK_CREATE: 'The SDK could not be found.',\n    IFRAME_NOT_FOUND: 'The specified iframe could not be found.',\n    EXPIRED_TOKEN: 'Your token has expired. Please generate a new one.',\n    DOM_NOT_IFRAME: 'Cannot build the iframe as the DOM element is not an iframe.',\n    INVALID_TOKEN: 'The token is invalid or has expired. Please generate a new token.',\n    INVALID_ORIGIN: 'The origin of the source is not supported.',\n    INVALID_DOMAIN: 'The domain of the source is not supported.',\n    ERROR_LOADING_IFRAME: 'Failed to load the iframe correctly.'\n};\n\nexport default errors;","export function checkOrigin(url: string): boolean {\n    try {\n        const providedOrigin = new URL(url).origin;\n        return providedOrigin === window.location.origin;\n    } catch (err) {\n        return false;\n    }\n}","export default [\n    '.sandboxqxm.com',\n    '.quienpormi.com',\n    '.quienxmi.com',\n    '.qxm.com.'\n];","import AllowedDomains from '../constants/allowedDomains';\n\nexport function checkDomain(url: string): boolean {\n    try {\n        const parsedUrl = new URL(url);\n\n        if (parsedUrl.hostname === 'localhost') {\n            return parsedUrl.port === '8000';\n        }\n\n        if (parsedUrl.protocol !== 'https:') {\n            return false;\n        }\n\n        const hostname = parsedUrl.hostname;\n        return AllowedDomains.some(domain => {\n            if (domain.endsWith('.')) {\n                return hostname.slice(0, -2).endsWith(domain);\n            }\n            return hostname.endsWith(domain);\n        });\n    } catch (err) {\n        return false;\n    }\n}","import { DecodedToken } from '../interfaces/index';\n\nconst requiredKeys = [\n    'iss',\n    'iat',\n    'exp',\n    'data'\n];\n\nfunction checkKeysInObject(jsonPayload: DecodedToken): boolean {\n    const payloadKeys = Object.keys(jsonPayload);\n    return requiredKeys.every(key => payloadKeys.includes(key));\n}\n\nexport function decodeToken(token: string) {\n    try {\n        const base64Url = token.split('.')[1];\n        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n        const jsonPayload: DecodedToken = JSON.parse(decodeURIComponent(atob(base64).split('').map(function (c) {\n            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);\n        }).join('')));\n        const currentTime = Math.floor(Date.now() / 1000);\n        if (jsonPayload.exp > currentTime && checkKeysInObject(jsonPayload)) {\n            return jsonPayload;\n        }\n        return null;\n    } catch (err) {\n        return null;\n    }\n}","import './interfaces/global.d';\nimport Errors from './constants/errors';\nimport { Config, SubscriptionTypes, Observer, DecodedToken, EventObserver, EventObserverError } from './interfaces/index';\nimport { checkOrigin } from './utils/checkOrigin';\nimport { checkDomain } from './utils/checkDomain';\nimport { decodeToken } from './utils/decodeToken';\nimport { version } from '../package.json';\n\nconst observersStructure: Observer = {\n    all: [],\n    resize: [],\n    event: [],\n    error: []\n};\n\nclass QxmIframeProject {\n    public _domIframe?: HTMLIFrameElement;\n    public _observers: Observer = observersStructure;\n\n    private _checkExp?: number | NodeJS.Timeout;\n    private _logs = false;\n\n    constructor(\n        domOrStringIframe: HTMLIFrameElement | string,\n        config: Config | null\n    ) {\n        try {\n            const { scrolling, resize, logs } = config ?? {};\n\n            if (typeof domOrStringIframe === 'string') {\n                this._domIframe = document.querySelector(domOrStringIframe)!;\n            } else {\n                this._domIframe = domOrStringIframe;\n            }\n\n            if (logs === true) {\n                this._logs = true;\n            }\n\n            if (this._logs) {\n                console.info('[QxmIframe]: Version ' + version)\n            }\n\n            if (!this._domIframe) {\n                this.pushError('IFRAME_NOT_FOUND');\n                return;\n            }\n\n            if (!(this._domIframe instanceof HTMLIFrameElement)) {\n                this.pushError('DOM_NOT_IFRAME');\n                return;\n            }\n\n            this._domIframe.setAttribute('frameborder', '0');\n\n            if (!(scrolling || false)) {\n                this._domIframe.setAttribute('scrolling', 'no');\n            }\n\n            this.createListener();\n\n            if (resize ?? true) {\n                this.subscribe('resize', this.resize);\n            }\n        } catch (e: any) {\n            this.pushError('SDK_CREATE', null, e);\n            this.destroy();\n        }\n    }\n\n    subscribe(type: SubscriptionTypes = 'all', callback: Function) {\n        this._observers[type].push(callback);\n    }\n\n    subscribeError(callback: Function) {\n        this.subscribe('error', callback);\n    }\n\n    subscribeEvent(callback: Function) {\n        this.subscribe('event', callback);\n    }\n\n    async setToken(token: string): Promise<DecodedToken | null> {\n        token = token.trim();\n        const decodedToken: DecodedToken | null = decodeToken(token);\n        clearInterval(this._checkExp);\n\n        if (!decodedToken) {\n            this.pushError('INVALID_TOKEN');\n            return null;\n        }\n\n        if (decodedToken.aud && !checkOrigin(decodedToken.aud)) {\n            this.pushError('INVALID_ORIGIN');\n            return null;\n        }\n\n        if (!checkDomain(decodedToken.iss)) {\n            this.pushError('INVALID_DOMAIN');\n            return null;\n        }\n\n        this._checkExp = setInterval(() => {\n            const now = Math.floor(Date.now() / 1000);\n            if (decodedToken.exp < now) {\n                clearInterval(this._checkExp);\n                this.pushError('EXPIRED_TOKEN');\n            }\n        }, 1000);\n\n        if (!await this.setSrcIframe(decodedToken.iss, token)) {\n            return null;\n        }\n\n        return decodedToken;\n    }\n\n    destroy() {\n        this._domIframe = undefined;\n        this._observers = observersStructure;\n        clearInterval(this._checkExp);\n    }\n\n    private setSrcIframe(domain: string, token: string): Promise<boolean> {\n        return new Promise((resolve) => {\n            const domIframe = this._domIframe!;\n\n            const onLoad = () => {\n                clearEvents();\n                resolve(true);\n            };\n\n            const onError = () => {\n                this.pushError('ERROR_LOADING_IFRAME');\n                clearEvents();\n                resolve(false);\n            };\n\n            const clearEvents = () => {\n                domIframe.removeEventListener('load', onLoad);\n                domIframe.removeEventListener('error', onError);\n            }\n\n            try {\n                domIframe.src = domain + '/api/iframe/project/create?token=' + token;\n                domIframe.addEventListener('load', onLoad);\n                domIframe.addEventListener('error', onError);\n            } catch (err) {\n                onError();\n            }\n        });\n    }\n\n    private createListener() {\n        window.addEventListener('message', (event: MessageEvent) => {\n            const { origin, data } = event;\n            if (checkDomain(origin)) {\n                if (this._logs) {\n                    console.log('[QxmIframe]:', data);\n                }\n                let type = data.type ?? 'all';\n                if (!this._observers[type]) {\n                    type = 'all';\n                }\n                if (type === 'error') {\n                    this.pushError(data.code, data.message);\n                    return;\n                }\n                this._observers[type].forEach((observer: Function) => observer({\n                    _domIframe: this._domIframe,\n                    data\n                } as EventObserver));\n            }\n        });\n    }\n\n    private pushError(code: string, message: string | null = null, error: any = null) {\n        if (!message) {\n            message = Errors[code] ?? code;\n        } \n        if (this._logs) {\n            console.error('[QxmIframe]:', message, error);\n        }\n        this._observers.error.forEach((observer: Function) => observer({\n            _domIframe: this._domIframe,\n            code,\n            message,\n            error\n        } as EventObserverError));\n    }\n\n    private resize(event: EventObserver) {\n        const { _domIframe, data } = event;\n        const styles = window.getComputedStyle(_domIframe);\n        const iframePadding = parseInt(styles.paddingTop) + parseInt(styles.paddingBottom);\n        _domIframe.style.setProperty('height', `${data.height + iframePadding}px`, 'important');\n    }\n}\n\nif (typeof window !== 'undefined') {\n    window.QxmIframeProject = QxmIframeProject;\n}\n\nexport default QxmIframeProject;"],"names":["errors","checkOrigin","url","AllowedDomains","checkDomain","parsedUrl","hostname","domain","requiredKeys","checkKeysInObject","jsonPayload","payloadKeys","key","decodeToken","token","base64","c","currentTime","observersStructure","QxmIframeProject","domOrStringIframe","config","__publicField","scrolling","resize","logs","version","e","type","callback","decodedToken","now","resolve","domIframe","onLoad","clearEvents","onError","event","origin","data","observer","code","message","error","Errors","_domIframe","styles","iframePadding"],"mappings":"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"}