(function(n,s){typeof exports=="object"&&typeof module<"u"?module.exports=s():typeof define=="function"&&define.amd?define(s):(n=typeof globalThis<"u"?globalThis:n||self,n.QxmIframeProject=s())})(this,function(){"use strict";var E=Object.defineProperty;var b=(n,s,c)=>s in n?E(n,s,{enumerable:!0,configurable:!0,writable:!0,value:c}):n[s]=c;var l=(n,s,c)=>b(n,typeof s!="symbol"?s+"":s,c);const n={SDK_CREATE:"The SDK could not be found.",IFRAME_NOT_FOUND:"The specified iframe could not be found.",EXPIRED_TOKEN:"Your token has expired. Please generate a new one.",DOM_NOT_IFRAME:"Cannot build the iframe as the DOM element is not an iframe.",INVALID_TOKEN:"The token is invalid or has expired. Please generate a new token.",INVALID_ORIGIN:"The origin of the source is not supported.",INVALID_DOMAIN:"The domain of the source is not supported.",ERROR_LOADING_IFRAME:"Failed to load the iframe correctly."};function s(a){try{return new URL(a).origin===window.location.origin}catch{return!1}}const c=[".sandboxqxm.com",".quienpormi.com",".quienxmi.com",".qxm.com."];function f(a){try{const e=new URL(a);if(e.hostname==="localhost")return e.port==="8000";if(e.protocol!=="https:")return!1;const r=e.hostname;return c.some(t=>t.endsWith(".")?r.slice(0,-2).endsWith(t):r.endsWith(t))}catch{return!1}}const I=["iss","iat","exp","data"];function _(a){const e=Object.keys(a);return I.every(r=>e.includes(r))}function p(a){try{const r=a.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),t=JSON.parse(decodeURIComponent(atob(r).split("").map(function(i){return"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)}).join(""))),o=Math.floor(Date.now()/1e3);return t.exp>o&&_(t)?t:null}catch{return null}}const g="1.0.6",h={all:[],resize:[],modals:[],error:[]};class m{constructor(e,r){l(this,"_domIframe");l(this,"_observers",h);l(this,"_checkExp");l(this,"_logs",!1);try{const{scrolling:t,resize:o,logs:i}=r??{};if(typeof e=="string"?this._domIframe=document.querySelector(e):this._domIframe=e,i===!0&&(this._logs=!0),this._logs&&console.info("[QxmIframe]: Version "+g),!this._domIframe){this.errorLog("IFRAME_NOT_FOUND");return}if(!(this._domIframe instanceof HTMLIFrameElement)){this.errorLog("DOM_NOT_IFRAME");return}this._domIframe.setAttribute("frameborder","0"),t||this._domIframe.setAttribute("scrolling","no"),this.createListener(),(o??!0)&&this.subscribe("resize",this.resize)}catch(t){this.errorLog("SDK_CREATE",t)}}subscribe(e="all",r){this._observers[e].push(r)}error(e){this.subscribe("error",e)}modals(e){this.subscribe("modals",e)}async setToken(e){const r=p(e);return clearInterval(this._checkExp),r?r.aud&&!s(r.aud)?(this.errorLog("INVALID_ORIGIN"),null):f(r.iss)?(this._checkExp=setInterval(()=>{const t=Math.floor(Date.now()/1e3);r.exp<t&&(clearInterval(this._checkExp),this.errorLog("EXPIRED_TOKEN"))},1e3),await this.setSrcIframe(r.iss,e)?r:null):(this.errorLog("INVALID_DOMAIN"),null):(this.errorLog("INVALID_TOKEN"),null)}destroy(){this._domIframe=void 0,this._observers=h,clearInterval(this._checkExp)}setSrcIframe(e,r){return new Promise(t=>{const o=this._domIframe,i=()=>{u(),t(!0)},d=()=>{this.errorLog("ERROR_LOADING_IFRAME"),u(),t(!1)},u=()=>{o.removeEventListener("load",i),o.removeEventListener("error",d)};try{o.src=e+"/api/iframe/project/create?token="+r,o.addEventListener("load",i),o.addEventListener("error",d)}catch{d()}})}createListener(){window.addEventListener("message",e=>{const{origin:r,data:t}=e;if(f(r)){this._logs&&console.log("[QxmIframe]:",t);let o=t.type??"all";this._observers[o]||(o="all"),this._observers[o].forEach(i=>i({_domIframe:this._domIframe,_observers:this._observers,data:t}))}})}errorLog(e,r=null){const t=n[e]??e;this._logs&&console.error("[QxmIframe]:",t,r),this._observers.error.forEach(o=>o({_domIframe:this._domIframe,_observers:this._observers,code:e,message:t,error:r}))}resize(e){const{_domIframe:r,data:t}=e,o=window.getComputedStyle(r),i=parseInt(o.paddingTop)+parseInt(o.paddingBottom);r.style.setProperty("height",`${t.height+i}px`,"important")}}return typeof window<"u"&&(window.QxmIframeProject=m),m});
//# sourceMappingURL=qxm-iframe-project.umd.js.map
